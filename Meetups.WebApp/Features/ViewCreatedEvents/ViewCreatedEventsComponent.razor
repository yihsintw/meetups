@page "/org/events"

@using Meetups.WebApp.Features.CreateEvent
@using Meetups.WebApp.Shared.ViewModels
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization

@inherits BaseComponent

@inject ViewCreatedEventsService ViewCreatedEventsService;

@attribute [Authorize(policy:"OrganizerOnly")]

@{
    var isAuthenticated = base.IsAuthenticated;
}
@* @attribute [Authorize(policy: "OrganizerOnly")] *@

<h3>Created Events</h3>
<div>
    Total count: @totalCount
</div>

@if (createdEvents is not null && createdEvents.Count > 0)
{
    <table class="table table-striped">
        <thead>
            <tr>
                
                <th style="width:150px;text-align:center">Title</th>
                @* <th>Description</th> *@
                <th>Begin Time</th>
                <th>End Time</th>
                @* <th>Location</th> *@
                <th>Capacity</th>
                <th>Has Cost</th>
                <th>Ticket Price</th>
                <th>Refundable</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var eventItem in createdEvents)
            {
                <tr>
                    <td style="text-align:center">
                        <a href="/org/events/edit/@eventItem.EventId" class="btn btn-primary">
                            @{
                                var imageUrl = string.IsNullOrEmpty(eventItem.ImageUrl) ? "/images/placeholder.png" : eventItem.ImageUrl;
                                if (!string.IsNullOrEmpty(imageUrl))
                                {
                                    <img class="img-thumbnail" src="@imageUrl" alt="Event Image" style="width:100px" />
                                }
                                <br />
                                @eventItem.Title
                            }
                        </a>
                    </td>

                    
                    @* <td>@eventItem.Description</td> *@
                    <td>@eventItem.BeginDate @eventItem.BeginTime</td>
                    <td>@eventItem.EndDate  @eventItem.EndTime</td>
                    @* <td>@eventItem.Location</td> *@
                    <td>@(eventItem.Capacity==0?"Unlimited":eventItem.Capacity.ToString())</td>

                    <td>@(eventItem.HasCost ? "Yes" : "No")</td>

                    <td>@(eventItem.TicketPrice.HasValue ? eventItem.TicketPrice.Value.ToString("$#,##0") : "Free")</td>

                    <td>@(eventItem.Refundable ? "Yes" : "No")</td>

                    <td>
                        <DeleteEventComponent ButtonClass="btn btn-link" EventViewModel="@eventItem" OnDeleted="OnDeleted" />
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
@* <button class="btn btn-primary" @onclick="CreateEvent">Create Event</button> *@
@* <br/>
<button class="btn btn-primary" @onclick="TestButton">Test Button</button>
<br/> *@
<a href="/org/events/create" class="btn btn-primary">Create New Meetup</a>
@code {
    private int totalCount = 0;
    private List<EventViewModel> createdEvents = new();

    private void TestButton()
    {
        var userId = base.UserId;
        Console.WriteLine("Test Button Clicked");
    }

    private void OnDeleted(int eventId)
    {
        if (createdEvents != null)
        {
            var deletedEvent = createdEvents.FirstOrDefault(e => e.EventId == eventId);
            if (deletedEvent != null)
            {
                createdEvents.Remove(deletedEvent);
                StateHasChanged();
            }
        }
    }


    protected async override Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);   

        if (firstRender)
        {   
            createdEvents = await ViewCreatedEventsService.GetEventsByCreatorIdAsync(base.UserId?.ToString() ?? "");
            totalCount = createdEvents.Count;
            StateHasChanged();
        }

        
    }

        
}
