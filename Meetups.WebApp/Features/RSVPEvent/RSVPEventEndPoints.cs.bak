using Meetups.WebApp.Data;
using Meetups.WebApp.Data.Entities;
using Meetups.WebApp.Shared.Services;
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Components;
using Microsoft.EntityFrameworkCore;
using System.Security.Claims;

namespace Meetups.WebApp.Features.RSVPEvent
{
    public static class RSVPEventEndPoints
    {
        public static void MapRSVPEventEndPoints(this WebApplication app)
        {
            app.MapGet("/rsvp/{eventId:int}/{paymentId?}/{paymentStatus?}",
                async (int eventId,
                    string? paymentId,
                    string? paymentStatus,
                    HttpContext context,
                    RSVPEventService rsvpEventService,
                    IDbContextFactory<ApplicationDbContext> contextFactory) =>
                {
                    var claims = context.User?.Claims;
                    //var name = claims?.FirstOrDefault(c => c.Type == ClaimTypes.Name)?.Value;
                    var email = claims?.FirstOrDefault(c => c.Type == ClaimTypes.Email)?.Value;
                    //var phoneNumber = claims?.FirstOrDefault(c => c.Type == ClaimTypes.MobilePhone)?.Value;

                    var result = await rsvpEventService.RSVPToEventAsync(eventId, email ?? "", paymentId, paymentStatus);
                    var errorMessage = string.Empty;
                    //result = false; // For testing error message display
                    if (result > 0)
                    {
                        using var dbContext = await contextFactory.CreateDbContextAsync();
                        var user = await dbContext.Users.FirstOrDefaultAsync(u => u.Email == email);

                        context.Response.Redirect($"/users/{user?.UserId}/manage-rsvp-events");
                    }
                    else
                    {
                        context.Response.Redirect($"/rsvp-error/{eventId}");
                    }

                }
            )
            //避免用户直接访问 RSVP 链接，要求用户必须登录才能访问
            .RequireAuthorization();
        }
    }
}
